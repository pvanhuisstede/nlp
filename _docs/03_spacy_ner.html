<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.0.38">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>nlp - Updating spaCy’s NER system</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="nlp - Updating spaCy’s NER system">
<meta property="og:description" content="Although pre-trained models are simple to use, we just have to plug them in, results will be disappointing when the data we work with differs, even slightly, from the data the model was trained on.">
<meta property="og:site-name" content="nlp">
<meta name="twitter:title" content="nlp - Updating spaCy’s NER system">
<meta name="twitter:description" content="Although pre-trained models are simple to use, we just have to plug them in, results will be disappointing when the data we work with differs, even slightly, from the data the model was trained on.">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">nlp</span>
  </a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/pvanhuisstede/nlp/"><i class="bi bi-github" role="img">
</i> 
 </a>
  </li>  
</ul>
              <div class="quarto-toggle-container">
                  <a href="" class="quarto-reader-toggle nav-link" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
              </div>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">Updating spaCy’s NER system</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">NLP Telematika tutorials</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./00_word_embeddings.html" class="sidebar-item-text sidebar-link">An introduction to word embeddings</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01_pretrained_models.html" class="sidebar-item-text sidebar-link">NLP with pre-trained models: spaCy and Stanford NLP</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02_discovering_topics.html" class="sidebar-item-text sidebar-link">Discovering and Visualizing Topics in Texts</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03_spacy_ner.html" class="sidebar-item-text sidebar-link active">Updating spaCy’s NER system</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04_ner_crf.html" class="sidebar-item-text sidebar-link">NER with Conditional Random Fields (CRF)</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05_ner_pytorch.html" class="sidebar-item-text sidebar-link">NER with PyTorch</a>
  </div>
</li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#training-a-completely-new-entity-type-in-spacy" id="toc-training-a-completely-new-entity-type-in-spacy" class="nav-link active" data-scroll-target="#training-a-completely-new-entity-type-in-spacy">Training a completely new entity type in spaCy</a></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/pvanhuisstede/nlp/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block">Updating spaCy’s NER system</h1>
</div>



<div class="quarto-title-meta">

    
    
  </div>
  

</header>

<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<p>Although pre-trained models are simple to use, we just have to plug them in, results will be disappointing when the data we work with differs, even slightly, from the data the model was trained on.</p>
<p>So, we want to be able to train our own model. SpaCy has us covered:</p>
<ul>
<li>we can train our model from scratch</li>
<li>we can continue a trained model with our own data.</li>
</ul>
<p>Let’s look at a toy example:</p>
<div class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.display <span class="im">import</span> display_html</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tabulate</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> spacy</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>nlp <span class="op">=</span> spacy.load(<span class="st">'en_core_web_sm'</span>)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>text <span class="op">=</span> <span class="st">"Alexander Boris de Pfeffel Johnson (born 19 June 1964) is a British politician who has served as Prime Minister of the United Kingdom and Leader of the Conservative Party since 2019; he lead the Vote Leave campaign for Brexit . "</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>doc <span class="op">=</span> nlp(text)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>entities <span class="op">=</span> [(t.text, t.ent_iob_, t.ent_type_) <span class="cf">for</span> t <span class="kw">in</span> doc]</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>display(display_html(tabulate.tabulate(entities, tablefmt<span class="op">=</span><span class="st">'html'</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<table>
<tbody>
<tr><td>Alexander   </td><td>B</td><td>PERSON</td></tr>
<tr><td>Boris       </td><td>I</td><td>PERSON</td></tr>
<tr><td>de          </td><td>I</td><td>PERSON</td></tr>
<tr><td>Pfeffel     </td><td>I</td><td>PERSON</td></tr>
<tr><td>Johnson     </td><td>I</td><td>PERSON</td></tr>
<tr><td>(           </td><td>O</td><td>      </td></tr>
<tr><td>born        </td><td>O</td><td>      </td></tr>
<tr><td>19          </td><td>B</td><td>DATE  </td></tr>
<tr><td>June        </td><td>I</td><td>DATE  </td></tr>
<tr><td>1964        </td><td>I</td><td>DATE  </td></tr>
<tr><td>)           </td><td>O</td><td>      </td></tr>
<tr><td>is          </td><td>O</td><td>      </td></tr>
<tr><td>a           </td><td>O</td><td>      </td></tr>
<tr><td>British     </td><td>B</td><td>NORP  </td></tr>
<tr><td>politician  </td><td>O</td><td>      </td></tr>
<tr><td>who         </td><td>O</td><td>      </td></tr>
<tr><td>has         </td><td>O</td><td>      </td></tr>
<tr><td>served      </td><td>O</td><td>      </td></tr>
<tr><td>as          </td><td>O</td><td>      </td></tr>
<tr><td>Prime       </td><td>O</td><td>      </td></tr>
<tr><td>Minister    </td><td>O</td><td>      </td></tr>
<tr><td>of          </td><td>O</td><td>      </td></tr>
<tr><td>the         </td><td>B</td><td>GPE   </td></tr>
<tr><td>United      </td><td>I</td><td>GPE   </td></tr>
<tr><td>Kingdom     </td><td>I</td><td>GPE   </td></tr>
<tr><td>and         </td><td>O</td><td>      </td></tr>
<tr><td>Leader      </td><td>O</td><td>      </td></tr>
<tr><td>of          </td><td>O</td><td>      </td></tr>
<tr><td>the         </td><td>B</td><td>ORG   </td></tr>
<tr><td>Conservative</td><td>I</td><td>ORG   </td></tr>
<tr><td>Party       </td><td>I</td><td>ORG   </td></tr>
<tr><td>since       </td><td>O</td><td>      </td></tr>
<tr><td>2019        </td><td>B</td><td>DATE  </td></tr>
<tr><td>;           </td><td>O</td><td>      </td></tr>
<tr><td>he          </td><td>O</td><td>      </td></tr>
<tr><td>lead        </td><td>O</td><td>      </td></tr>
<tr><td>the         </td><td>O</td><td>      </td></tr>
<tr><td>Vote        </td><td>O</td><td>      </td></tr>
<tr><td>Leave       </td><td>O</td><td>      </td></tr>
<tr><td>campaign    </td><td>O</td><td>      </td></tr>
<tr><td>for         </td><td>O</td><td>      </td></tr>
<tr><td>Brexit      </td><td>B</td><td>PERSON</td></tr>
<tr><td>.           </td><td>O</td><td>      </td></tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">
<pre><code>None</code></pre>
</div>
</div>
<p>Although the spaCy NER is actually quite good, we want to train the model some more with extra training data. So that a word like “Brexit” for example is properly recognized. For this we do not use the actual sentence itself, too easy. But we will use similar sentences. Here we will use just a couple of sentences from Wikipedia.</p>
<p>Below are the 18 NER labels that spaCy uses:</p>
<div class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>ner_lst <span class="op">=</span> nlp.pipe_labels[<span class="st">'ner'</span>]</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(ner_lst)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> ner_lst:</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>spacy<span class="sc">.</span>explain(i)<span class="sc">}</span><span class="ch">\n</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>['CARDINAL', 'DATE', 'EVENT', 'FAC', 'GPE', 'LANGUAGE', 'LAW', 'LOC', 'MONEY', 'NORP', 'ORDINAL', 'ORG', 'PERCENT', 'PERSON', 'PRODUCT', 'QUANTITY', 'TIME', 'WORK_OF_ART']
CARDINAL: Numerals that do not fall under another type

DATE: Absolute or relative dates or periods

EVENT: Named hurricanes, battles, wars, sports events, etc.

FAC: Buildings, airports, highways, bridges, etc.

GPE: Countries, cities, states

LANGUAGE: Any named language

LAW: Named documents made into laws.

LOC: Non-GPE locations, mountain ranges, bodies of water

MONEY: Monetary values, including unit

NORP: Nationalities or religious or political groups

ORDINAL: "first", "second", etc.

ORG: Companies, agencies, institutions, etc.

PERCENT: Percentage, including "%"

PERSON: People, including fictional

PRODUCT: Objects, vehicles, foods, etc. (not services)

QUANTITY: Measurements, as of weight or distance

TIME: Times smaller than a day

WORK_OF_ART: Titles of books, songs, etc.
</code></pre>
</div>
</div>
<p>So, we have this existing pre-trained spaCy model that we want to update with some new examples (ideally these should be around 200-300 examples).</p>
<p>These examples should be presented to spaCy as a list of tuples, that contain the text, and a dictionary of tuples, named entities that contains: the start and end indices of the named entity in the text, and the label of that named entity:</p>
<div class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>train_data <span class="op">=</span> [</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  (<span class="st">"Boris Johnson announced his pending resignation on 7 July 2022."</span>, {<span class="st">"entities"</span>: [(<span class="dv">0</span>,<span class="dv">13</span>,<span class="st">"PERSON"</span>), (<span class="dv">36</span>,<span class="dv">47</span>,<span class="st">"EVENT"</span>), (<span class="dv">51</span>,<span class="dv">62</span>,<span class="st">"DATE"</span>)]}),</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  (<span class="st">"He will remain as prime minister until a new party leader is elected."</span>, {<span class="st">"entities"</span>: [(<span class="dv">18</span>,<span class="dv">32</span>,<span class="st">"NORP"</span>), (<span class="dv">45</span>,<span class="dv">57</span>,<span class="st">"NORP"</span>), (<span class="dv">61</span>,<span class="dv">68</span>,<span class="st">"EVENT"</span>)]}),</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  (<span class="st">"He served as Secretary of State for Foreign and Commonwealth Affairs from 2016 to 2018."</span>, {<span class="st">"entities"</span>: [(<span class="dv">13</span>,<span class="dv">68</span>,<span class="st">"NORP"</span>), (<span class="dv">74</span>,<span class="dv">86</span>,<span class="st">"DATE"</span>)]}),</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  (<span class="st">"Boris Johnson served as Mayor of London from 2008 to 2016."</span>, {<span class="st">"entities"</span>: [(<span class="dv">0</span>,<span class="dv">13</span>,<span class="st">"PERSON"</span>), (<span class="dv">24</span>,<span class="dv">39</span>,<span class="st">"NORP"</span>), (<span class="dv">45</span>,<span class="dv">57</span>,<span class="st">"DATE"</span>)]}),</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  (<span class="st">"He became a prominent figure in the successful Vote Leave campaign for Brexit in the 2016 European Union (EU) membership referendum."</span>, {<span class="st">"entities"</span>: [(<span class="dv">47</span>,<span class="dv">66</span>,<span class="st">"EVENT"</span>), (<span class="dv">71</span>,<span class="dv">77</span>,<span class="st">"EVENT"</span>), (<span class="dv">85</span>,<span class="dv">89</span>,<span class="st">"DATE"</span>), (<span class="dv">90</span>,<span class="dv">104</span>,<span class="st">"ORG"</span>), (<span class="dv">106</span>,<span class="dv">108</span>,<span class="st">"ORG"</span>), (<span class="dv">121</span>,<span class="dv">131</span>,<span class="st">"EVENT"</span>)]}),</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Before we set up the NER pipeline with the content of our training data, we make sure that we got the indices right:</p>
<div class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>test <span class="op">=</span> <span class="st">"Boris Johnson announced his pending resignation on 7 July 2022."</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>test[<span class="dv">36</span>:<span class="dv">47</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="14">
<pre><code>'resignation'</code></pre>
</div>
</div>
<p>To set thing up, let’s check if we have a NER in our pipeline:</p>
<div class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>nlp.pipe_names</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="15">
<pre><code>['tok2vec', 'tagger', 'parser', 'attribute_ruler', 'lemmatizer', 'ner']</code></pre>
</div>
</div>
<p>That looks OK, now we assign the NER to a variable:</p>
<div class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>ner <span class="op">=</span> nlp.get_pipe(<span class="st">'ner'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next step is to add these labels to the NER:</p>
<div class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> _, annotations <span class="kw">in</span> train_data:</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> ent <span class="kw">in</span> annotations.get(<span class="st">"entities"</span>):</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    ner.add_label(ent[<span class="dv">2</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we can start training, but only for the NER component of the pipeline, hence the following code snippet:</p>
<div class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>pipe_exceptions <span class="op">=</span> [<span class="st">"ner"</span>, <span class="st">"trf_wordpiecer"</span>, <span class="st">"trf_tok2vec"</span>]</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>unaffected_pipes <span class="op">=</span> [pipe <span class="cf">for</span> pipe <span class="kw">in</span> nlp.pipe_names <span class="cf">if</span> pipe <span class="kw">not</span> <span class="kw">in</span> pipe_exceptions]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In order to properly train the NER model, we need to:</p>
<ul>
<li>let the ner model loop over the examples for a sufficient number of iterations (10)</li>
<li>shuffle the examples in order NOT to base the training on the sequence (<code>random.shuffle()</code>)</li>
<li>pass the training data in batches (<code>minibatch</code>)</li>
<li>the use <code>nlp.update()</code></li>
</ul>
<div class="cell" data-execution_count="35">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> spacy.util <span class="im">import</span> minibatch, compounding</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> spacy.training <span class="im">import</span> Example</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> nlp.disable_pipes(<span class="op">*</span>unaffected_pipes):</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> iteration <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">10</span>):</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    random.shuffle(train_data)</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    losses <span class="op">=</span> {}</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    batches <span class="op">=</span> minibatch(train_data, size<span class="op">=</span>compounding(<span class="fl">4.0</span>, <span class="fl">32.0</span>, <span class="fl">1.001</span>))</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> batch <span class="kw">in</span> batches:</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>      texts, annotations <span class="op">=</span> <span class="bu">zip</span>(<span class="op">*</span>batch)</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>      <span class="co"># new way of updating nlp NOT using nlp.update() anymore</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>      example <span class="op">=</span> []</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>      <span class="co"># update the model with iterating each text</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(texts)):</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>        doc <span class="op">=</span> nlp.make_doc(texts[i])</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>        example.append(Example.from_dict(doc, annotations[i]))</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>      nlp.update(example, drop<span class="op">=</span><span class="fl">0.5</span>, losses<span class="op">=</span>losses)</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(losses)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{'ner': 15.376934256244896}</code></pre>
</div>
</div>
<p>Let’s check how our updated NER model now performs, using our earlier sentence:</p>
<div class="cell" data-execution_count="36">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>text <span class="op">=</span> <span class="st">"Alexander Boris de Pfeffel Johnson (born 19 June 1964) is a British politician who has served as Prime Minister of the United Kingdom and Leader of the Conservative Party since 2019; he lead the Vote Leave campaign for Brexit . "</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>doc <span class="op">=</span> nlp(text)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>entities <span class="op">=</span> [(t.text, t.ent_iob_, t.ent_type_) <span class="cf">for</span> t <span class="kw">in</span> doc]</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>display(display_html(tabulate.tabulate(entities, tablefmt<span class="op">=</span><span class="st">'html'</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<table>
<tbody>
<tr><td>Alexander   </td><td>B</td><td>PERSON</td></tr>
<tr><td>Boris       </td><td>I</td><td>PERSON</td></tr>
<tr><td>de          </td><td>I</td><td>PERSON</td></tr>
<tr><td>Pfeffel     </td><td>I</td><td>PERSON</td></tr>
<tr><td>Johnson     </td><td>I</td><td>PERSON</td></tr>
<tr><td>(           </td><td>O</td><td>      </td></tr>
<tr><td>born        </td><td>O</td><td>      </td></tr>
<tr><td>19          </td><td>B</td><td>DATE  </td></tr>
<tr><td>June        </td><td>I</td><td>DATE  </td></tr>
<tr><td>1964        </td><td>I</td><td>DATE  </td></tr>
<tr><td>)           </td><td>O</td><td>      </td></tr>
<tr><td>is          </td><td>O</td><td>      </td></tr>
<tr><td>a           </td><td>O</td><td>      </td></tr>
<tr><td>British     </td><td>B</td><td>NORP  </td></tr>
<tr><td>politician  </td><td>O</td><td>      </td></tr>
<tr><td>who         </td><td>O</td><td>      </td></tr>
<tr><td>has         </td><td>O</td><td>      </td></tr>
<tr><td>served      </td><td>O</td><td>      </td></tr>
<tr><td>as          </td><td>O</td><td>      </td></tr>
<tr><td>Prime       </td><td>B</td><td>NORP  </td></tr>
<tr><td>Minister    </td><td>I</td><td>NORP  </td></tr>
<tr><td>of          </td><td>I</td><td>NORP  </td></tr>
<tr><td>the         </td><td>I</td><td>NORP  </td></tr>
<tr><td>United      </td><td>I</td><td>NORP  </td></tr>
<tr><td>Kingdom     </td><td>I</td><td>NORP  </td></tr>
<tr><td>and         </td><td>O</td><td>      </td></tr>
<tr><td>Leader      </td><td>B</td><td>NORP  </td></tr>
<tr><td>of          </td><td>I</td><td>NORP  </td></tr>
<tr><td>the         </td><td>I</td><td>NORP  </td></tr>
<tr><td>Conservative</td><td>I</td><td>NORP  </td></tr>
<tr><td>Party       </td><td>I</td><td>NORP  </td></tr>
<tr><td>since       </td><td>O</td><td>      </td></tr>
<tr><td>2019        </td><td>B</td><td>DATE  </td></tr>
<tr><td>;           </td><td>O</td><td>      </td></tr>
<tr><td>he          </td><td>O</td><td>      </td></tr>
<tr><td>lead        </td><td>O</td><td>      </td></tr>
<tr><td>the         </td><td>O</td><td>      </td></tr>
<tr><td>Vote        </td><td>O</td><td>      </td></tr>
<tr><td>Leave       </td><td>O</td><td>      </td></tr>
<tr><td>campaign    </td><td>O</td><td>      </td></tr>
<tr><td>for         </td><td>O</td><td>      </td></tr>
<tr><td>Brexit      </td><td>B</td><td>EVENT </td></tr>
<tr><td>.           </td><td>O</td><td>      </td></tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">
<pre><code>None</code></pre>
</div>
</div>
<p>Better, but we trained a little bit on the subject which is precisely why we, the RePubXL team, propose supervised ML on smaller contextual datasets. The power of these NER updates is that, based on the examples, the model can generalize due to the word-embeddings vectorspace.</p>
<p>Now, we want to keep our updated model for future use:</p>
<div class="cell" data-execution_count="38">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># save the model to a directory</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>output_dir <span class="op">=</span> Path(<span class="st">'content/'</span>)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>nlp.to_disk(output_dir)</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Saved model to: </span><span class="sc">{</span>output_dir<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Saved model to: content</code></pre>
</div>
</div>
<div class="cell" data-execution_count="39">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the saved model to predict</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Loading from: </span><span class="sc">{</span>output_dir<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>nlp_updated <span class="op">=</span> spacy.load(output_dir)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>doc <span class="op">=</span> nlp_updated(<span class="st">"Johnson is a controversial figure in British politics."</span>)</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Entities"</span>, [(ent.text, ent.label_) <span class="cf">for</span> ent <span class="kw">in</span> doc.ents])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Loading from: content
Entities [('Johnson', 'PERSON'), ('British', 'NORP')]</code></pre>
</div>
</div>
<p>In the cells above we started with a pre-trained model. One can also choose to start with an empty model, using <code>spacy.blank()</code>, passing in the “en” argument for the English language. Because it is an empty model, we have to add this <code>ner</code> to the pipeline using <code>add_pipe()</code>. We do not have to disable other pipelines, as we are just adding a new one, <strong>not</strong> changing an existing one.</p>
<p>One does have to use a large(r) number of training cases.</p>
<p>Just a small example below:</p>
<div class="cell" data-execution_count="42">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Build upon the spaCy Small Model</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>nlp <span class="op">=</span> spacy.blank(<span class="st">"en"</span>)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="co">#Sample text</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>text <span class="op">=</span> <span class="st">"Treblinka is a small village in Poland. Wikipedia notes that Treblinka is not large."</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="co">#Create the EntityRuler</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>ruler <span class="op">=</span> nlp.add_pipe(<span class="st">"entity_ruler"</span>)</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a><span class="co">#List of Entities and Patterns</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>patterns <span class="op">=</span> [</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>                {<span class="st">"label"</span>: <span class="st">"GPE"</span>, <span class="st">"pattern"</span>: <span class="st">"Treblinka"</span>}</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>            ]</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>ruler.add_patterns(patterns)</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>doc <span class="op">=</span> nlp(text)</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a><span class="co">#extract entities</span></span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ent <span class="kw">in</span> doc.ents:</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span> (ent.text, ent.start_char, ent.end_char, ent.label_)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Treblinka 0 9 GPE
Treblinka 61 70 GPE</code></pre>
</div>
</div>
<p>We can use our new model to get more info and train it:</p>
<div class="cell" data-execution_count="43">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Import the requisite library</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> spacy</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="co">#Build upon the spaCy Small Model</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>nlp <span class="op">=</span> spacy.load(<span class="st">"en_core_web_sm"</span>)</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="co">#Sample text</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>text <span class="op">=</span> <span class="st">"Treblinka is a small village in Poland. Wikipedia notes that Treblinka is not large."</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>corpus <span class="op">=</span> []</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>doc <span class="op">=</span> nlp(text)</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> sent <span class="kw">in</span> doc.sents:</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>    corpus.append(sent.text)</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a><span class="co">#Build upon the spaCy Small Model</span></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>nlp <span class="op">=</span> spacy.blank(<span class="st">"en"</span>)</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a><span class="co">#Create the EntityRuler</span></span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>ruler <span class="op">=</span> nlp.add_pipe(<span class="st">"entity_ruler"</span>)</span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a><span class="co">#List of Entities and Patterns</span></span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>patterns <span class="op">=</span> [</span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>                {<span class="st">"label"</span>: <span class="st">"GPE"</span>, <span class="st">"pattern"</span>: <span class="st">"Treblinka"</span>}</span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>            ]</span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>ruler.add_patterns(patterns)</span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a>TRAIN_DATA <span class="op">=</span> []</span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a><span class="co">#iterate over the corpus again</span></span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> sentence <span class="kw">in</span> corpus:</span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a>    doc <span class="op">=</span> nlp(sentence)</span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a>    <span class="co">#remember, entities needs to be a dictionary in index 1 of the list, so it needs to be an empty list</span></span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true" tabindex="-1"></a>    entities <span class="op">=</span> []</span>
<span id="cb23-38"><a href="#cb23-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-39"><a href="#cb23-39" aria-hidden="true" tabindex="-1"></a>    <span class="co">#extract entities</span></span>
<span id="cb23-40"><a href="#cb23-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> ent <span class="kw">in</span> doc.ents:</span>
<span id="cb23-41"><a href="#cb23-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-42"><a href="#cb23-42" aria-hidden="true" tabindex="-1"></a>        <span class="co">#appending to entities in the correct format</span></span>
<span id="cb23-43"><a href="#cb23-43" aria-hidden="true" tabindex="-1"></a>        entities.append([ent.start_char, ent.end_char, ent.label_])</span>
<span id="cb23-44"><a href="#cb23-44" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-45"><a href="#cb23-45" aria-hidden="true" tabindex="-1"></a>    TRAIN_DATA.append([sentence, {<span class="st">"entities"</span>: entities}])</span>
<span id="cb23-46"><a href="#cb23-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-47"><a href="#cb23-47" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span> (TRAIN_DATA)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[['Treblinka is a small village in Poland.', {'entities': [[0, 9, 'GPE']]}], ['Wikipedia notes that Treblinka is not large.', {'entities': [[21, 30, 'GPE']]}]]</code></pre>
</div>
</div>
<section id="training-a-completely-new-entity-type-in-spacy" class="level2">
<h2 class="anchored" data-anchor-id="training-a-completely-new-entity-type-in-spacy">Training a completely new entity type in spaCy</h2>
<p>All code above was directed at training the <code>ner</code> to categorize correctly, either adjusting a pre-trained model or starting from a new blank model and adjusting that as one goes.</p>
<p>But what to do if you want to work with a category that is NOT defined?</p>
<div class="cell" data-execution_count="46">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the `ner` component of the pipeline</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>nlp <span class="op">=</span> spacy.load(<span class="st">'en_core_web_sm'</span>)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>ner <span class="op">=</span> nlp.get_pipe(<span class="st">'ner'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="47">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the new label</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>LABEL <span class="op">=</span> <span class="st">"FOOD"</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Training examples in the required format</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>TRAIN_DATA <span class="op">=</span>[ (<span class="st">"Pizza is a common fast food."</span>, {<span class="st">"entities"</span>: [(<span class="dv">0</span>, <span class="dv">5</span>, <span class="st">"FOOD"</span>)]}),</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>              (<span class="st">"Pasta is an italian recipe"</span>, {<span class="st">"entities"</span>: [(<span class="dv">0</span>, <span class="dv">5</span>, <span class="st">"FOOD"</span>)]}),</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>              (<span class="st">"China's noodles are very famous"</span>, {<span class="st">"entities"</span>: [(<span class="dv">8</span>,<span class="dv">14</span>, <span class="st">"FOOD"</span>)]}),</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>              (<span class="st">"Shrimps are famous in China too"</span>, {<span class="st">"entities"</span>: [(<span class="dv">0</span>,<span class="dv">7</span>, <span class="st">"FOOD"</span>)]}),</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>              (<span class="st">"Lasagna is another classic of Italy"</span>, {<span class="st">"entities"</span>: [(<span class="dv">0</span>,<span class="dv">7</span>, <span class="st">"FOOD"</span>)]}),</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>              (<span class="st">"Sushi is extemely famous and expensive Japanese dish"</span>, {<span class="st">"entities"</span>: [(<span class="dv">0</span>,<span class="dv">5</span>, <span class="st">"FOOD"</span>)]}),</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>              (<span class="st">"Unagi is a famous seafood of Japan"</span>, {<span class="st">"entities"</span>: [(<span class="dv">0</span>,<span class="dv">5</span>, <span class="st">"FOOD"</span>)]}),</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>              (<span class="st">"Tempura , Soba are other famous dishes of Japan"</span>, {<span class="st">"entities"</span>: [(<span class="dv">0</span>,<span class="dv">7</span>, <span class="st">"FOOD"</span>)]}),</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>              (<span class="st">"Udon is a healthy type of noodles"</span>, {<span class="st">"entities"</span>: [(<span class="dv">0</span>,<span class="dv">4</span>, <span class="st">"ORG"</span>)]}),</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>              (<span class="st">"Chocolate soufflé is extremely famous french cuisine"</span>, {<span class="st">"entities"</span>: [(<span class="dv">0</span>,<span class="dv">17</span>, <span class="st">"FOOD"</span>)]}),</span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>              (<span class="st">"Flamiche is french pastry"</span>, {<span class="st">"entities"</span>: [(<span class="dv">0</span>,<span class="dv">8</span>, <span class="st">"FOOD"</span>)]}),</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>              (<span class="st">"Burgers are the most commonly consumed fastfood"</span>, {<span class="st">"entities"</span>: [(<span class="dv">0</span>,<span class="dv">7</span>, <span class="st">"FOOD"</span>)]}),</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>              (<span class="st">"Burgers are the most commonly consumed fastfood"</span>, {<span class="st">"entities"</span>: [(<span class="dv">0</span>,<span class="dv">7</span>, <span class="st">"FOOD"</span>)]}),</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>              (<span class="st">"Frenchfries are considered too oily"</span>, {<span class="st">"entities"</span>: [(<span class="dv">0</span>,<span class="dv">11</span>, <span class="st">"FOOD"</span>)]})</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>           ]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We have to train the model:</p>
<ul>
<li>first add the new label with <code>ner.add_label()</code></li>
<li>Resume training</li>
<li>Select the pipes to be trained</li>
<li>Single out the pipes NOT to be trained</li>
</ul>
<div class="cell" data-execution_count="48">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the new label to ner</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>ner.add_label(LABEL)</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Resume training</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> nlp.resume_training()</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>move_names <span class="op">=</span> <span class="bu">list</span>(ner.move_names)</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a><span class="co"># List of pipes you want to train</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>pipe_exceptions <span class="op">=</span> [<span class="st">"ner"</span>, <span class="st">"trf_wordpiecer"</span>, <span class="st">"trf_tok2vec"</span>]</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a><span class="co"># List of pipes which should remain unaffected in training</span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>other_pipes <span class="op">=</span> [pipe <span class="cf">for</span> pipe <span class="kw">in</span> nlp.pipe_names <span class="cf">if</span> pipe <span class="kw">not</span> <span class="kw">in</span> pipe_exceptions]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="52">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Importing requirements</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> spacy.util <span class="im">import</span> minibatch, compounding</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Begin training by disabling other pipeline components</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> nlp.disable_pipes(<span class="op">*</span>other_pipes):</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>  sizes <span class="op">=</span> compounding(<span class="fl">1.0</span>, <span class="fl">4.0</span>, <span class="fl">1.001</span>)</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> iteration <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">30</span>):</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>    random.shuffle(TRAIN_DATA)</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>    losses <span class="op">=</span> {}</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>    batches <span class="op">=</span> minibatch(TRAIN_DATA, size<span class="op">=</span>sizes)</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> batch <span class="kw">in</span> batches:</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>      texts, annotations <span class="op">=</span> <span class="bu">zip</span>(<span class="op">*</span>batch)</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>      <span class="co"># new way of updating nlp NOT using nlp.update() anymore</span></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>      example <span class="op">=</span> []</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>      <span class="co"># update the model with iterating each text</span></span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(texts)):</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>        doc <span class="op">=</span> nlp.make_doc(texts[i])</span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>        example.append(Example.from_dict(doc, annotations[i]))</span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>      nlp.update(example, drop<span class="op">=</span><span class="fl">0.5</span>, losses<span class="op">=</span>losses)</span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(losses)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{'ner': 1.698520319920043}</code></pre>
</div>
</div>
<p>With the training complete, let’s test our <code>ner</code>:</p>
<div class="cell" data-execution_count="53">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>test_text <span class="op">=</span> <span class="st">"I ate Sushi yesterday. Maggi is a common fast food "</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>doc <span class="op">=</span> nlp(test_text)</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Entities in '</span><span class="sc">%s</span><span class="st">'"</span> <span class="op">%</span> test_text)</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ent <span class="kw">in</span> doc.ents:</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>  <span class="bu">print</span>(ent)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Entities in 'I ate Sushi yesterday. Maggi is a common fast food '
Sushi
Maggi</code></pre>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>