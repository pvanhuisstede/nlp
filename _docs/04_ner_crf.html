<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.0.38">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>nlp - NER with Conditional Random Fields (CRF)</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="nlp - NER with Conditional Random Fields (CRF)">
<meta property="og:description" content="CRF is a powerful technique before Deep Learning became popular.">
<meta property="og:site-name" content="nlp">
<meta name="twitter:title" content="nlp - NER with Conditional Random Fields (CRF)">
<meta name="twitter:description" content="CRF is a powerful technique before Deep Learning became popular.">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">nlp</span>
  </a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/pvanhuisstede/nlp/"><i class="bi bi-github" role="img">
</i> 
 </a>
  </li>  
</ul>
              <div class="quarto-toggle-container">
                  <a href="" class="quarto-reader-toggle nav-link" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
              </div>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">NER with Conditional Random Fields (CRF)</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">NLP Telematika tutorials</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./00_word_embeddings.html" class="sidebar-item-text sidebar-link">An introduction to word embeddings</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01_pretrained_models.html" class="sidebar-item-text sidebar-link">NLP with pre-trained models: spaCy and Stanford NLP</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02_discovering_topics.html" class="sidebar-item-text sidebar-link">Discovering and Visualizing Topics in Texts</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03_spacy_ner.html" class="sidebar-item-text sidebar-link">Updating spaCy’s NER system</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04_ner_crf.html" class="sidebar-item-text sidebar-link active">NER with Conditional Random Fields (CRF)</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05_ner_pytorch.html" class="sidebar-item-text sidebar-link">NER with PyTorch</a>
  </div>
</li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#finding-the-optimal-hyperparameters" id="toc-finding-the-optimal-hyperparameters" class="nav-link active" data-scroll-target="#finding-the-optimal-hyperparameters">Finding the optimal hyperparameters</a></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/pvanhuisstede/nlp/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block">NER with Conditional Random Fields (CRF)</h1>
</div>



<div class="quarto-title-meta">

    
    
  </div>
  

</header>

<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<p>CRF is a powerful technique before Deep Learning became popular. POS tagging of sequences in order to label the most important information related to the problem at hand: generic named entities (locations, people, and organizations) or more specialized entities such as disease or symptomes.</p>
<p>For this we use <code>sklearn-crfsuite</code>.</p>
<p>I guess, due to the upsurge of Deep Learning the <code>sklearn-crfsuite</code> is not updated anymore. So instead of the snippet below, we have to install an updated version of the library to be able to produce reports:</p>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!pip install sklearn-crfsuite # Run only once</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Collecting sklearn_crfsuite
  Cloning https://github.com/MeMartijn/updated-sklearn-crfsuite.git to /tmp/pip-install-gmb2mkie/sklearn-crfsuite_4ea39345fa9f4076b8a39c8b860aeef3
  Running command git clone --filter=blob:none --quiet https://github.com/MeMartijn/updated-sklearn-crfsuite.git /tmp/pip-install-gmb2mkie/sklearn-crfsuite_4ea39345fa9f4076b8a39c8b860aeef3
  Resolved https://github.com/MeMartijn/updated-sklearn-crfsuite.git to commit 675038761b4405f04691a83339d04903790e2b95
  Preparing metadata (setup.py) ... done
Requirement already satisfied: tqdm&gt;=2.0 in /home/peter/anaconda3/envs/py38/lib/python3.8/site-packages (from sklearn_crfsuite) (4.64.0)
Requirement already satisfied: six in /home/peter/anaconda3/envs/py38/lib/python3.8/site-packages (from sklearn_crfsuite) (1.16.0)
Requirement already satisfied: tabulate in /home/peter/anaconda3/envs/py38/lib/python3.8/site-packages (from sklearn_crfsuite) (0.8.10)
Requirement already satisfied: python-crfsuite&gt;=0.8.3 in /home/peter/anaconda3/envs/py38/lib/python3.8/site-packages (from sklearn_crfsuite) (0.9.8)
Note: you may need to restart the kernel to use updated packages.</code></pre>
</div>
</div>
<p>Data comes from NLTK:</p>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> nltk</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sklearn</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> classification_report, confusion_matrix</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> LabelBinarizer</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sklearn_crfsuite <span class="im">as</span> crfsuite</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn_crfsuite <span class="im">import</span> metrics</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">#nltk.download('conll2002') # Just run this line once</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>train_sents <span class="op">=</span> <span class="bu">list</span>(nltk.corpus.conll2002.iob_sents(<span class="st">'ned.train'</span>))</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>dev_sents <span class="op">=</span> <span class="bu">list</span>(nltk.corpus.conll2002.iob_sents(<span class="st">'ned.testa'</span>))</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>test_sents <span class="op">=</span> <span class="bu">list</span>(nltk.corpus.conll2002.iob_sents(<span class="st">'ned.testb'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s have a look at the data. They are a list of tokenized sentences: the string, POS tag and it’s entity tag. Nowadays the POS tag is not used in deep learning, but with CRF it provides useful information: Nouns are more common denoting entities than verbs, so the POS tags carry useful information.</p>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>train_sents[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="5">
<pre><code>[('De', 'Art', 'O'),
 ('tekst', 'N', 'O'),
 ('van', 'Prep', 'O'),
 ('het', 'Art', 'O'),
 ('arrest', 'N', 'O'),
 ('is', 'V', 'O'),
 ('nog', 'Adv', 'O'),
 ('niet', 'Adv', 'O'),
 ('schriftelijk', 'Adj', 'O'),
 ('beschikbaar', 'Adj', 'O'),
 ('maar', 'Conj', 'O'),
 ('het', 'Art', 'O'),
 ('bericht', 'N', 'O'),
 ('werd', 'V', 'O'),
 ('alvast', 'Adv', 'O'),
 ('bekendgemaakt', 'V', 'O'),
 ('door', 'Prep', 'O'),
 ('een', 'Art', 'O'),
 ('communicatiebureau', 'N', 'O'),
 ('dat', 'Conj', 'O'),
 ('Floralux', 'N', 'B-ORG'),
 ('inhuurde', 'V', 'O'),
 ('.', 'Punc', 'O')]</code></pre>
</div>
</div>
<p>How does CRF work? Deep learning neural nets just learn their relevant features from the input texts themselves. CRFs learn the realtionship between <strong>the features we give them</strong> and the <strong>label of a token in a given context</strong>. They <strong>do not</strong> learn these features themselves, the quality of the model highly depends on the features we present to them.</p>
<p>We therefore:</p>
<ul>
<li><p>use a method to collect the features for every token:</p>
<ul>
<li>the word itself + POS tag</li>
<li>completely uppercase? starts with digit? starts with capital?</li>
<li>character bigram or trigram the word ends with</li>
<li>use a <code>bias</code> feature that always has the same value (through it the CRF model can learn the relative freq. of each label type in the training data)</li>
</ul></li>
<li><p>we use the word embeddings to give the model more information about the meaning of a word (500 wikipedia clusters of word embeddings). We read those from file and map each word to the ID of the cluster it is in. Define <code>read_clusters</code>.</p></li>
<li><p>we want the CRF to look at the context of a token. We provide the CRF with the 2 words on either side of the token: their case, POS tags. If there is no left or right, we give it that information: BOS or EOS.</p></li>
</ul>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Making use of the Wikipedia word embeddings</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> read_clusters(cluster_file):</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  word2cluster <span class="op">=</span> {}</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">with</span> <span class="bu">open</span>(cluster_file) <span class="im">as</span> i:</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> line <span class="kw">in</span> i:</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>      word, cluster <span class="op">=</span> line.strip().split(<span class="st">'</span><span class="ch">\t</span><span class="st">'</span>)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>      word2cluster[word] <span class="op">=</span> cluster</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> word2cluster</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Using features of the words AND looking at the context of a token (neigbours +/- 2)</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> word2features(sent, i, word2cluster):</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>  word <span class="op">=</span> sent[i][<span class="dv">0</span>]</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>  postag <span class="op">=</span> sent[i][<span class="dv">1</span>]</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>  features <span class="op">=</span> [</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">'bias'</span>,</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">'word.lower='</span> <span class="op">+</span> word.lower(),</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">'word[-3]='</span> <span class="op">+</span> word[<span class="op">-</span><span class="dv">3</span>:], <span class="co"># looking at the last 3 chars of the token</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">'word[-2]='</span> <span class="op">+</span> word[<span class="op">-</span><span class="dv">2</span>:], <span class="co"># looking at the last 2 chars of the token</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">'word.isupper=</span><span class="sc">%s</span><span class="st">'</span> <span class="op">%</span> word.isupper(),</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">'word.istitle=</span><span class="sc">%s</span><span class="st">'</span> <span class="op">%</span> word.istitle(),</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">'word.isdigit=</span><span class="sc">%s</span><span class="st">'</span> <span class="op">%</span> word.isdigit(),</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">'word.cluster=</span><span class="sc">%s</span><span class="st">'</span> <span class="op">%</span> word2cluster[word.lower()] <span class="cf">if</span> word.lower() <span class="kw">in</span> word2cluster <span class="cf">else</span> <span class="st">'0'</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">'postag='</span> <span class="op">+</span> postag</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>  ]</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Look at the first neighbour token to the left</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> i <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>    word1 <span class="op">=</span> sent[i<span class="op">-</span><span class="dv">1</span>][<span class="dv">0</span>]</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>    postag1 <span class="op">=</span> sent[i<span class="op">-</span><span class="dv">1</span>][<span class="dv">1</span>]</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>    features.extend([</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>      <span class="st">'-1:word.lower='</span> <span class="op">+</span> word1.lower(),</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>      <span class="st">'-1:word.istitle=</span><span class="sc">%s</span><span class="st">'</span> <span class="op">%</span> word1.istitle(),</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>      <span class="st">'-1:word.isupper=</span><span class="sc">%s</span><span class="st">'</span> <span class="op">%</span> word1.isupper(),</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>      <span class="st">'-1:postag='</span> <span class="op">+</span> postag1</span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span>:</span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>    features.append(<span class="st">'BOS'</span>)</span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Look at the second neighbour to the left</span></span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> i <span class="op">&gt;</span> <span class="dv">1</span>: </span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>    word2 <span class="op">=</span> sent[i<span class="op">-</span><span class="dv">2</span>][<span class="dv">0</span>]</span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>    postag2 <span class="op">=</span> sent[i<span class="op">-</span><span class="dv">2</span>][<span class="dv">1</span>]</span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>    features.extend([</span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>      <span class="st">'-2:word.lower='</span> <span class="op">+</span> word2.lower(),</span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>      <span class="st">'-2:word.istitle=</span><span class="sc">%s</span><span class="st">'</span> <span class="op">%</span> word2.istitle(),</span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>      <span class="st">'-2:word.isupper=</span><span class="sc">%s</span><span class="st">'</span> <span class="op">%</span> word2.isupper(),</span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a>      <span class="st">'-2:postag='</span> <span class="op">+</span> postag2</span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>  <span class="co"># look at the first neigbour to the right</span></span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> i <span class="op">&lt;</span> <span class="bu">len</span>(sent)<span class="op">-</span><span class="dv">1</span>:</span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a>    word1 <span class="op">=</span> sent[i<span class="op">+</span><span class="dv">1</span>][<span class="dv">0</span>]</span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a>    postag1 <span class="op">=</span> sent[<span class="op">+</span><span class="dv">1</span>][<span class="dv">0</span>]</span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a>    features.extend([</span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a>      <span class="st">'+1:word.lower='</span> <span class="op">+</span> word1.lower(),</span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a>      <span class="st">'+1:word.istitle=</span><span class="sc">%s</span><span class="st">'</span> <span class="op">%</span> word1.istitle(),</span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a>      <span class="st">"+1:word.isupper=</span><span class="sc">%s</span><span class="st">"</span> <span class="op">%</span> word1.isupper(),</span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a>      <span class="st">'+1:postag='</span> <span class="op">+</span> postag1</span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb8-57"><a href="#cb8-57" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span>:</span>
<span id="cb8-58"><a href="#cb8-58" aria-hidden="true" tabindex="-1"></a>    features.append(<span class="st">'EOS'</span>)</span>
<span id="cb8-59"><a href="#cb8-59" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Look at the second neighbour to the right</span></span>
<span id="cb8-60"><a href="#cb8-60" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> i <span class="op">&lt;</span> <span class="bu">len</span>(sent)<span class="op">-</span><span class="dv">2</span>:</span>
<span id="cb8-61"><a href="#cb8-61" aria-hidden="true" tabindex="-1"></a>    word2 <span class="op">=</span> sent[i<span class="op">+</span><span class="dv">2</span>][<span class="dv">0</span>]</span>
<span id="cb8-62"><a href="#cb8-62" aria-hidden="true" tabindex="-1"></a>    postag2 <span class="op">=</span> sent[<span class="op">+</span><span class="dv">2</span>][<span class="dv">0</span>]</span>
<span id="cb8-63"><a href="#cb8-63" aria-hidden="true" tabindex="-1"></a>    features.extend([</span>
<span id="cb8-64"><a href="#cb8-64" aria-hidden="true" tabindex="-1"></a>      <span class="st">'+2:word.lower='</span> <span class="op">+</span> word2.lower(),</span>
<span id="cb8-65"><a href="#cb8-65" aria-hidden="true" tabindex="-1"></a>      <span class="st">'+2:word.istitle=</span><span class="sc">%s</span><span class="st">'</span> <span class="op">%</span> word2.istitle(),</span>
<span id="cb8-66"><a href="#cb8-66" aria-hidden="true" tabindex="-1"></a>      <span class="st">"+2:word.isupper=</span><span class="sc">%s</span><span class="st">"</span> <span class="op">%</span> word2.isupper(),</span>
<span id="cb8-67"><a href="#cb8-67" aria-hidden="true" tabindex="-1"></a>      <span class="st">'+2:postag='</span> <span class="op">+</span> postag2</span>
<span id="cb8-68"><a href="#cb8-68" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb8-69"><a href="#cb8-69" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> features</span>
<span id="cb8-70"><a href="#cb8-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-71"><a href="#cb8-71" aria-hidden="true" tabindex="-1"></a><span class="co"># Now we define the functions to do all the work</span></span>
<span id="cb8-72"><a href="#cb8-72" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sent2features(sent, word2cluster):</span>
<span id="cb8-73"><a href="#cb8-73" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> [word2features(sent, i, word2cluster) <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(sent))]</span>
<span id="cb8-74"><a href="#cb8-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-75"><a href="#cb8-75" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sent2labels(sent):</span>
<span id="cb8-76"><a href="#cb8-76" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> [label <span class="cf">for</span> token, postag, label <span class="kw">in</span> sent]</span>
<span id="cb8-77"><a href="#cb8-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-78"><a href="#cb8-78" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sent2tokens(sent):</span>
<span id="cb8-79"><a href="#cb8-79" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> [token <span class="cf">for</span> token, postag, label <span class="kw">in</span> sent]</span>
<span id="cb8-80"><a href="#cb8-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-81"><a href="#cb8-81" aria-hidden="true" tabindex="-1"></a>word2cluster <span class="op">=</span> read_clusters(<span class="st">'/home/peter/Documents/data/nlp/clusters_nl.tsv'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s try the <code>sent2features</code> function out using the first word from the first training_sent:</p>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>train_sents[<span class="dv">0</span>][<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<pre><code>('De', 'Art', 'O')</code></pre>
</div>
</div>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>sent2features(train_sents[<span class="dv">0</span>], word2cluster)[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="8">
<pre><code>['bias',
 'word.lower=de',
 'word[-3]=De',
 'word[-2]=De',
 'word.isupper=False',
 'word.istitle=True',
 'word.isdigit=False',
 'word.cluster=38',
 'BOS',
 '+1:word.lower=tekst',
 '+1:word.istitle=False',
 '+1:word.isupper=False',
 '+1:postag=tekst',
 '+2:word.lower=van',
 '+2:word.istitle=False',
 '+2:word.isupper=False',
 '+2:postag=van']</code></pre>
</div>
</div>
<p>Now we assign our training and test sets the appropriate labels:</p>
<div class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>X_train <span class="op">=</span> [sent2features(s, word2cluster) <span class="cf">for</span> s <span class="kw">in</span> train_sents]</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>y_train <span class="op">=</span> [sent2labels(s) <span class="cf">for</span> s <span class="kw">in</span> train_sents]</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>X_dev <span class="op">=</span> [sent2features(s, word2cluster) <span class="cf">for</span> s <span class="kw">in</span> dev_sents]</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>y_dev <span class="op">=</span> [sent2labels(s) <span class="cf">for</span> s <span class="kw">in</span> dev_sents]</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>X_test <span class="op">=</span> [sent2features(s, word2cluster) <span class="cf">for</span> s <span class="kw">in</span> test_sents]</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> [sent2labels(s) <span class="cf">for</span> s <span class="kw">in</span> test_sents]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next we create a CRF model and start the training using the standard <code>lbfgs</code> algorithm for parameter estimation and run it for 100 iterations.</p>
<p>When done, we save the model using <code>joblib</code>.</p>
<div class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>crf <span class="op">=</span> crfsuite.CRF(</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    verbose<span class="op">=</span><span class="st">'true'</span>,</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    algorithm<span class="op">=</span><span class="st">'lbfgs'</span>,</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    max_iterations<span class="op">=</span><span class="dv">100</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>crf.fit(X_train, y_train, X_dev<span class="op">=</span>X_dev, y_dev<span class="op">=</span>y_dev)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>loading training data to CRFsuite: 100%|██████████| 15806/15806 [00:01&lt;00:00, 10327.34it/s]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>loading dev data to CRFsuite: 100%|██████████| 2895/2895 [00:00&lt;00:00, 9481.62it/s]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Holdout group: 2

Feature generation
type: CRF1d
feature.minfreq: 0.000000
feature.possible_states: 0
feature.possible_transitions: 0
0....1....2....3....4....5....6....7....8....9....10
Number of features: 171320
Seconds required: 0.419

L-BFGS optimization
c1: 0.000000
c2: 1.000000
num_memories: 6
max_iterations: 100
epsilon: 0.000010
stop: 10
delta: 0.000010
linesearch: MoreThuente
linesearch.max_iterations: 20

Iter 1   time=0.28  loss=104683.26 active=171320 precision=0.100  recall=0.111  F1=0.105  Acc(item/seq)=0.901 0.496  feature_norm=1.00
Iter 2   time=0.16  loss=96793.85 active=171320 precision=0.100  recall=0.111  F1=0.105  Acc(item/seq)=0.901 0.496  feature_norm=1.15
Iter 3   time=0.16  loss=92785.91 active=171320 precision=0.100  recall=0.111  F1=0.105  Acc(item/seq)=0.901 0.496  feature_norm=1.26
Iter 4   time=0.16  loss=87079.17 active=171320 precision=0.100  recall=0.111  F1=0.105  Acc(item/seq)=0.901 0.496  feature_norm=1.46
Iter 5   time=0.16  loss=74874.43 active=171320 precision=0.100  recall=0.111  F1=0.105  Acc(item/seq)=0.901 0.496  feature_norm=2.06
Iter 6   time=0.16  loss=56175.11 active=171320 precision=0.367  recall=0.212  F1=0.205  Acc(item/seq)=0.914 0.528  feature_norm=3.80
Iter 7   time=0.16  loss=49697.02 active=171320 precision=0.327  recall=0.336  F1=0.312  Acc(item/seq)=0.928 0.570  feature_norm=4.88
Iter 8   time=0.16  loss=43311.61 active=171320 precision=0.347  recall=0.378  F1=0.342  Acc(item/seq)=0.935 0.605  feature_norm=6.41
Iter 9   time=0.16  loss=39075.88 active=171320 precision=0.552  recall=0.435  F1=0.440  Acc(item/seq)=0.940 0.626  feature_norm=8.23
Iter 10  time=0.16  loss=36519.06 active=171320 precision=0.553  recall=0.446  F1=0.447  Acc(item/seq)=0.942 0.645  feature_norm=8.92
Iter 11  time=0.16  loss=34579.58 active=171320 precision=0.539  recall=0.452  F1=0.445  Acc(item/seq)=0.943 0.651  feature_norm=9.76
Iter 12  time=0.17  loss=33027.56 active=171320 precision=0.540  recall=0.457  F1=0.451  Acc(item/seq)=0.943 0.654  feature_norm=10.85
Iter 13  time=0.17  loss=30299.19 active=171320 precision=0.537  recall=0.493  F1=0.489  Acc(item/seq)=0.945 0.664  feature_norm=13.28
Iter 14  time=0.16  loss=29249.47 active=171320 precision=0.577  recall=0.523  F1=0.516  Acc(item/seq)=0.948 0.670  feature_norm=14.53
Iter 15  time=0.17  loss=28170.22 active=171320 precision=0.668  recall=0.494  F1=0.508  Acc(item/seq)=0.948 0.668  feature_norm=13.45
Iter 16  time=0.17  loss=27023.73 active=171320 precision=0.679  recall=0.511  F1=0.526  Acc(item/seq)=0.949 0.676  feature_norm=13.75
Iter 17  time=0.16  loss=25631.34 active=171320 precision=0.666  recall=0.555  F1=0.573  Acc(item/seq)=0.952 0.698  feature_norm=14.54
Iter 18  time=0.16  loss=24453.50 active=171320 precision=0.658  recall=0.573  F1=0.591  Acc(item/seq)=0.954 0.709  feature_norm=15.41
Iter 19  time=0.17  loss=22684.11 active=171320 precision=0.633  recall=0.593  F1=0.600  Acc(item/seq)=0.954 0.711  feature_norm=17.45
Iter 20  time=0.16  loss=21363.83 active=171320 precision=0.669  recall=0.598  F1=0.612  Acc(item/seq)=0.956 0.721  feature_norm=19.11
Iter 21  time=0.16  loss=20830.16 active=171320 precision=0.673  recall=0.594  F1=0.617  Acc(item/seq)=0.957 0.721  feature_norm=19.29
Iter 22  time=0.16  loss=20155.15 active=171320 precision=0.683  recall=0.596  F1=0.620  Acc(item/seq)=0.957 0.722  feature_norm=19.42
Iter 23  time=0.17  loss=19700.84 active=171320 precision=0.695  recall=0.598  F1=0.626  Acc(item/seq)=0.957 0.719  feature_norm=19.22
Iter 24  time=0.16  loss=19128.84 active=171320 precision=0.681  recall=0.590  F1=0.611  Acc(item/seq)=0.954 0.710  feature_norm=19.78
Iter 25  time=0.16  loss=18404.39 active=171320 precision=0.682  recall=0.598  F1=0.624  Acc(item/seq)=0.957 0.717  feature_norm=19.61
Iter 26  time=0.16  loss=18268.58 active=171320 precision=0.681  recall=0.607  F1=0.627  Acc(item/seq)=0.958 0.722  feature_norm=19.79
Iter 27  time=0.16  loss=17815.24 active=171320 precision=0.668  recall=0.611  F1=0.618  Acc(item/seq)=0.958 0.730  feature_norm=20.55
Iter 28  time=0.17  loss=17284.00 active=171320 precision=0.682  recall=0.619  F1=0.626  Acc(item/seq)=0.959 0.738  feature_norm=22.00
Iter 29  time=0.16  loss=16735.40 active=171320 precision=0.678  recall=0.630  F1=0.642  Acc(item/seq)=0.959 0.742  feature_norm=22.71
Iter 30  time=0.16  loss=16329.82 active=171320 precision=0.701  recall=0.634  F1=0.658  Acc(item/seq)=0.961 0.745  feature_norm=23.25
Iter 31  time=0.16  loss=15934.11 active=171320 precision=0.711  recall=0.634  F1=0.663  Acc(item/seq)=0.961 0.747  feature_norm=24.00
Iter 32  time=0.17  loss=15793.83 active=171320 precision=0.733  recall=0.629  F1=0.665  Acc(item/seq)=0.961 0.740  feature_norm=25.18
Iter 33  time=0.16  loss=15409.50 active=171320 precision=0.717  recall=0.639  F1=0.667  Acc(item/seq)=0.961 0.743  feature_norm=25.49
Iter 34  time=0.16  loss=15173.77 active=171320 precision=0.707  recall=0.643  F1=0.664  Acc(item/seq)=0.962 0.749  feature_norm=25.46
Iter 35  time=0.17  loss=14809.61 active=171320 precision=0.714  recall=0.661  F1=0.672  Acc(item/seq)=0.962 0.750  feature_norm=25.88
Iter 36  time=0.17  loss=14298.46 active=171320 precision=0.712  recall=0.666  F1=0.680  Acc(item/seq)=0.963 0.753  feature_norm=27.18
Iter 37  time=0.16  loss=14100.25 active=171320 precision=0.700  recall=0.643  F1=0.652  Acc(item/seq)=0.962 0.748  feature_norm=29.00
Iter 38  time=0.16  loss=13835.29 active=171320 precision=0.704  recall=0.653  F1=0.667  Acc(item/seq)=0.963 0.752  feature_norm=29.18
Iter 39  time=0.17  loss=13667.00 active=171320 precision=0.712  recall=0.650  F1=0.673  Acc(item/seq)=0.963 0.750  feature_norm=29.53
Iter 40  time=0.17  loss=13405.07 active=171320 precision=0.738  recall=0.667  F1=0.696  Acc(item/seq)=0.964 0.752  feature_norm=30.41
Iter 41  time=0.16  loss=13043.15 active=171320 precision=0.741  recall=0.674  F1=0.702  Acc(item/seq)=0.965 0.753  feature_norm=32.12
Iter 42  time=0.30  loss=12878.32 active=171320 precision=0.745  recall=0.669  F1=0.700  Acc(item/seq)=0.965 0.752  feature_norm=33.10
Iter 43  time=0.16  loss=12674.20 active=171320 precision=0.733  recall=0.666  F1=0.691  Acc(item/seq)=0.964 0.752  feature_norm=34.04
Iter 44  time=0.16  loss=12481.12 active=171320 precision=0.730  recall=0.670  F1=0.689  Acc(item/seq)=0.964 0.755  feature_norm=34.73
Iter 45  time=0.16  loss=12285.07 active=171320 precision=0.727  recall=0.669  F1=0.685  Acc(item/seq)=0.964 0.762  feature_norm=35.32
Iter 46  time=0.16  loss=11996.62 active=171320 precision=0.727  recall=0.676  F1=0.690  Acc(item/seq)=0.965 0.765  feature_norm=36.59
Iter 47  time=0.16  loss=11955.68 active=171320 precision=0.736  recall=0.677  F1=0.694  Acc(item/seq)=0.965 0.769  feature_norm=36.73
Iter 48  time=0.16  loss=11670.63 active=171320 precision=0.726  recall=0.672  F1=0.689  Acc(item/seq)=0.965 0.762  feature_norm=37.13
Iter 49  time=0.16  loss=11590.71 active=171320 precision=0.732  recall=0.676  F1=0.697  Acc(item/seq)=0.965 0.762  feature_norm=37.18
Iter 50  time=0.16  loss=11508.82 active=171320 precision=0.736  recall=0.668  F1=0.696  Acc(item/seq)=0.965 0.758  feature_norm=37.21
Iter 51  time=0.16  loss=11385.11 active=171320 precision=0.747  recall=0.679  F1=0.706  Acc(item/seq)=0.965 0.760  feature_norm=37.39
Iter 52  time=0.16  loss=11221.01 active=171320 precision=0.757  recall=0.683  F1=0.714  Acc(item/seq)=0.966 0.766  feature_norm=37.95
Iter 53  time=0.16  loss=11072.04 active=171320 precision=0.756  recall=0.691  F1=0.714  Acc(item/seq)=0.967 0.773  feature_norm=38.75
Iter 54  time=0.16  loss=10976.00 active=171320 precision=0.753  recall=0.690  F1=0.712  Acc(item/seq)=0.967 0.776  feature_norm=39.29
Iter 55  time=0.16  loss=10853.24 active=171320 precision=0.755  recall=0.692  F1=0.714  Acc(item/seq)=0.967 0.778  feature_norm=40.07
Iter 56  time=0.16  loss=10762.11 active=171320 precision=0.745  recall=0.701  F1=0.719  Acc(item/seq)=0.968 0.781  feature_norm=41.34
Iter 57  time=0.16  loss=10624.85 active=171320 precision=0.755  recall=0.696  F1=0.720  Acc(item/seq)=0.968 0.779  feature_norm=41.56
Iter 58  time=0.16  loss=10453.10 active=171320 precision=0.765  recall=0.692  F1=0.720  Acc(item/seq)=0.968 0.782  feature_norm=42.18
Iter 59  time=0.16  loss=10258.35 active=171320 precision=0.769  recall=0.689  F1=0.720  Acc(item/seq)=0.968 0.781  feature_norm=43.65
Iter 60  time=0.31  loss=10183.71 active=171320 precision=0.779  recall=0.702  F1=0.730  Acc(item/seq)=0.968 0.782  feature_norm=44.49
Iter 61  time=0.16  loss=10076.86 active=171320 precision=0.778  recall=0.704  F1=0.732  Acc(item/seq)=0.969 0.784  feature_norm=45.78
Iter 62  time=0.16  loss=10015.00 active=171320 precision=0.782  recall=0.711  F1=0.739  Acc(item/seq)=0.969 0.783  feature_norm=46.24
Iter 63  time=0.16  loss=9931.66  active=171320 precision=0.774  recall=0.711  F1=0.737  Acc(item/seq)=0.969 0.783  feature_norm=46.68
Iter 64  time=0.16  loss=9803.68  active=171320 precision=0.767  recall=0.713  F1=0.736  Acc(item/seq)=0.969 0.784  feature_norm=47.45
Iter 65  time=0.17  loss=9701.67  active=171320 precision=0.779  recall=0.705  F1=0.736  Acc(item/seq)=0.970 0.783  feature_norm=48.63
Iter 66  time=0.16  loss=9639.15  active=171320 precision=0.779  recall=0.708  F1=0.737  Acc(item/seq)=0.969 0.784  feature_norm=48.33
Iter 67  time=0.16  loss=9598.77  active=171320 precision=0.773  recall=0.703  F1=0.731  Acc(item/seq)=0.969 0.782  feature_norm=48.19
Iter 68  time=0.16  loss=9540.64  active=171320 precision=0.774  recall=0.704  F1=0.732  Acc(item/seq)=0.969 0.784  feature_norm=48.31
Iter 69  time=0.16  loss=9413.68  active=171320 precision=0.768  recall=0.701  F1=0.728  Acc(item/seq)=0.969 0.782  feature_norm=49.24
Iter 70  time=0.16  loss=9380.77  active=171320 precision=0.761  recall=0.702  F1=0.726  Acc(item/seq)=0.969 0.788  feature_norm=49.99
Iter 71  time=0.17  loss=9304.96  active=171320 precision=0.770  recall=0.698  F1=0.727  Acc(item/seq)=0.969 0.784  feature_norm=49.95
Iter 72  time=0.16  loss=9281.71  active=171320 precision=0.768  recall=0.701  F1=0.729  Acc(item/seq)=0.969 0.783  feature_norm=50.13
Iter 73  time=0.16  loss=9235.57  active=171320 precision=0.768  recall=0.690  F1=0.721  Acc(item/seq)=0.968 0.780  feature_norm=50.92
Iter 74  time=0.16  loss=9174.10  active=171320 precision=0.772  recall=0.703  F1=0.731  Acc(item/seq)=0.969 0.782  feature_norm=51.34
Iter 75  time=0.16  loss=9113.84  active=171320 precision=0.772  recall=0.704  F1=0.732  Acc(item/seq)=0.969 0.784  feature_norm=51.94
Iter 76  time=0.16  loss=9070.10  active=171320 precision=0.773  recall=0.702  F1=0.730  Acc(item/seq)=0.969 0.788  feature_norm=52.42
Iter 77  time=0.16  loss=9004.30  active=171320 precision=0.770  recall=0.702  F1=0.729  Acc(item/seq)=0.969 0.788  feature_norm=53.14
Iter 78  time=0.16  loss=8984.87  active=171320 precision=0.778  recall=0.707  F1=0.735  Acc(item/seq)=0.969 0.789  feature_norm=54.97
Iter 79  time=0.16  loss=8872.31  active=171320 precision=0.769  recall=0.710  F1=0.733  Acc(item/seq)=0.969 0.789  feature_norm=54.86
Iter 80  time=0.17  loss=8835.66  active=171320 precision=0.767  recall=0.710  F1=0.732  Acc(item/seq)=0.969 0.787  feature_norm=54.89
Iter 81  time=0.17  loss=8784.90  active=171320 precision=0.765  recall=0.702  F1=0.726  Acc(item/seq)=0.969 0.789  feature_norm=55.33
Iter 82  time=0.16  loss=8767.61  active=171320 precision=0.775  recall=0.702  F1=0.733  Acc(item/seq)=0.969 0.787  feature_norm=56.06
Iter 83  time=0.17  loss=8728.88  active=171320 precision=0.772  recall=0.703  F1=0.731  Acc(item/seq)=0.969 0.787  feature_norm=56.51
Iter 84  time=0.16  loss=8712.06  active=171320 precision=0.781  recall=0.708  F1=0.738  Acc(item/seq)=0.970 0.791  feature_norm=56.58
Iter 85  time=0.16  loss=8684.72  active=171320 precision=0.785  recall=0.703  F1=0.736  Acc(item/seq)=0.970 0.792  feature_norm=56.98
Iter 86  time=0.16  loss=8648.08  active=171320 precision=0.784  recall=0.703  F1=0.734  Acc(item/seq)=0.969 0.790  feature_norm=57.61
Iter 87  time=0.16  loss=8596.04  active=171320 precision=0.782  recall=0.711  F1=0.740  Acc(item/seq)=0.970 0.793  feature_norm=58.61
Iter 88  time=0.30  loss=8578.00  active=171320 precision=0.780  recall=0.710  F1=0.738  Acc(item/seq)=0.970 0.792  feature_norm=59.13
Iter 89  time=0.16  loss=8557.37  active=171320 precision=0.775  recall=0.710  F1=0.737  Acc(item/seq)=0.970 0.791  feature_norm=59.34
Iter 90  time=0.16  loss=8534.07  active=171320 precision=0.772  recall=0.719  F1=0.741  Acc(item/seq)=0.970 0.793  feature_norm=59.73
Iter 91  time=0.16  loss=8507.33  active=171320 precision=0.772  recall=0.716  F1=0.739  Acc(item/seq)=0.970 0.792  feature_norm=59.70
Iter 92  time=0.16  loss=8483.16  active=171320 precision=0.772  recall=0.716  F1=0.739  Acc(item/seq)=0.970 0.792  feature_norm=59.70
Iter 93  time=0.16  loss=8454.27  active=171320 precision=0.778  recall=0.715  F1=0.741  Acc(item/seq)=0.970 0.792  feature_norm=59.84
Iter 94  time=0.16  loss=8424.34  active=171320 precision=0.780  recall=0.711  F1=0.739  Acc(item/seq)=0.970 0.791  feature_norm=59.85
Iter 95  time=0.31  loss=8393.51  active=171320 precision=0.788  recall=0.713  F1=0.744  Acc(item/seq)=0.970 0.793  feature_norm=60.32
Iter 96  time=0.16  loss=8353.12  active=171320 precision=0.789  recall=0.711  F1=0.743  Acc(item/seq)=0.970 0.792  feature_norm=60.27
Iter 97  time=0.16  loss=8327.82  active=171320 precision=0.790  recall=0.718  F1=0.748  Acc(item/seq)=0.971 0.793  feature_norm=60.18
Iter 98  time=0.16  loss=8312.62  active=171320 precision=0.792  recall=0.721  F1=0.751  Acc(item/seq)=0.971 0.792  feature_norm=60.07
Iter 99  time=0.16  loss=8301.72  active=171320 precision=0.791  recall=0.724  F1=0.753  Acc(item/seq)=0.971 0.791  feature_norm=59.93
Iter 100 time=0.16  loss=8286.46  active=171320 precision=0.787  recall=0.721  F1=0.748  Acc(item/seq)=0.970 0.791  feature_norm=59.82
================================================
Label      Precision    Recall     F1    Support
-------  -----------  --------  -----  ---------
B-LOC          0.814     0.806  0.810        479
B-MISC         0.786     0.650  0.712        748
B-ORG          0.837     0.599  0.698        686
B-PER          0.753     0.825  0.787        703
I-LOC          0.589     0.516  0.550         64
I-MISC         0.617     0.516  0.562        215
I-ORG          0.836     0.654  0.734        396
I-PER          0.859     0.922  0.889        423
O              0.988     0.998  0.993      33973
------------------------------------------------
L-BFGS terminated with the maximum number of iterations
Total seconds required for training: 17.012

Storing the model
Number of active features: 171320 (171320)
Number of active attributes: 138015 (154350)
Number of active labels: 9 (9)
Writing labels
Writing attributes
Writing feature references for transitions
Writing feature references for attributes
Seconds required: 0.058
</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="10">
<style>#sk-container-id-1 {color: black;background-color: white;}#sk-container-id-1 pre{padding: 0;}#sk-container-id-1 div.sk-toggleable {background-color: white;}#sk-container-id-1 label.sk-toggleable__label {cursor: pointer;display: block;width: 100%;margin-bottom: 0;padding: 0.3em;box-sizing: border-box;text-align: center;}#sk-container-id-1 label.sk-toggleable__label-arrow:before {content: "▸";float: left;margin-right: 0.25em;color: #696969;}#sk-container-id-1 label.sk-toggleable__label-arrow:hover:before {color: black;}#sk-container-id-1 div.sk-estimator:hover label.sk-toggleable__label-arrow:before {color: black;}#sk-container-id-1 div.sk-toggleable__content {max-height: 0;max-width: 0;overflow: hidden;text-align: left;background-color: #f0f8ff;}#sk-container-id-1 div.sk-toggleable__content pre {margin: 0.2em;color: black;border-radius: 0.25em;background-color: #f0f8ff;}#sk-container-id-1 input.sk-toggleable__control:checked~div.sk-toggleable__content {max-height: 200px;max-width: 100%;overflow: auto;}#sk-container-id-1 input.sk-toggleable__control:checked~label.sk-toggleable__label-arrow:before {content: "▾";}#sk-container-id-1 div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-1 div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-1 input.sk-hidden--visually {border: 0;clip: rect(1px 1px 1px 1px);clip: rect(1px, 1px, 1px, 1px);height: 1px;margin: -1px;overflow: hidden;padding: 0;position: absolute;width: 1px;}#sk-container-id-1 div.sk-estimator {font-family: monospace;background-color: #f0f8ff;border: 1px dotted black;border-radius: 0.25em;box-sizing: border-box;margin-bottom: 0.5em;}#sk-container-id-1 div.sk-estimator:hover {background-color: #d4ebff;}#sk-container-id-1 div.sk-parallel-item::after {content: "";width: 100%;border-bottom: 1px solid gray;flex-grow: 1;}#sk-container-id-1 div.sk-label:hover label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-1 div.sk-serial::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 0;bottom: 0;left: 50%;z-index: 0;}#sk-container-id-1 div.sk-serial {display: flex;flex-direction: column;align-items: center;background-color: white;padding-right: 0.2em;padding-left: 0.2em;position: relative;}#sk-container-id-1 div.sk-item {position: relative;z-index: 1;}#sk-container-id-1 div.sk-parallel {display: flex;align-items: stretch;justify-content: center;background-color: white;position: relative;}#sk-container-id-1 div.sk-item::before, #sk-container-id-1 div.sk-parallel-item::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 0;bottom: 0;left: 50%;z-index: -1;}#sk-container-id-1 div.sk-parallel-item {display: flex;flex-direction: column;z-index: 1;position: relative;background-color: white;}#sk-container-id-1 div.sk-parallel-item:first-child::after {align-self: flex-end;width: 50%;}#sk-container-id-1 div.sk-parallel-item:last-child::after {align-self: flex-start;width: 50%;}#sk-container-id-1 div.sk-parallel-item:only-child::after {width: 0;}#sk-container-id-1 div.sk-dashed-wrapped {border: 1px dashed gray;margin: 0 0.4em 0.5em 0.4em;box-sizing: border-box;padding-bottom: 0.4em;background-color: white;}#sk-container-id-1 div.sk-label label {font-family: monospace;font-weight: bold;display: inline-block;line-height: 1.2em;}#sk-container-id-1 div.sk-label-container {text-align: center;}#sk-container-id-1 div.sk-container {/* jupyter's `normalize.less` sets `[hidden] { display: none; }` but bootstrap.min.css set `[hidden] { display: none !important; }` so we also need the `!important` here to be able to override the default hidden behavior on the sphinx rendered scikit-learn.org. See: https://github.com/scikit-learn/scikit-learn/issues/21755 */display: inline-block !important;position: relative;}#sk-container-id-1 div.sk-text-repr-fallback {display: none;}</style><div id="sk-container-id-1" class="sk-top-container"><div class="sk-text-repr-fallback"><pre>CRF(algorithm='lbfgs', max_iterations=100, verbose='true')</pre><b>In a Jupyter environment, please rerun this cell to show the HTML representation or trust the notebook. <br>On GitHub, the HTML representation is unable to render, please try loading this page with nbviewer.org.</b></div><div class="sk-container" hidden=""><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-1" type="checkbox" checked=""><label for="sk-estimator-id-1" class="sk-toggleable__label sk-toggleable__label-arrow">CRF</label><div class="sk-toggleable__content"><pre>CRF(algorithm='lbfgs', max_iterations=100, verbose='true')</pre></div></div></div></div></div>
</div>
</div>
<p>There is an error, but this has to do with the sklearn version we use; to let the error disappear we should use sklearn &lt; 24.0.</p>
<p>Let’s see whether we can write our model to file:</p>
<div class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> joblib</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>OUTPUT_PATH <span class="op">=</span> <span class="st">'/home/peter/Documents/data/nlp/models'</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>OUTPUT_FILE <span class="op">=</span> <span class="st">'crf_model'</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(OUTPUT_PATH):</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>  os.mkdir(OUTPUT_PATH)</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>joblib.dump(crf, os.path.join(OUTPUT_PATH, OUTPUT_FILE))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<pre><code>['/home/peter/Documents/data/nlp/models/crf_model']</code></pre>
</div>
</div>
<p>With our model saved, we now can evaluate the output of our CRF model. We will load our model from file and test it on the full test set.</p>
<p>We will have a look at the first sentence.</p>
<div class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>crf <span class="op">=</span> joblib.load(os.path.join(OUTPUT_PATH, OUTPUT_FILE))</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>y_pred <span class="op">=</span> crf.predict(X_test)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>example_sent <span class="op">=</span> test_sents[<span class="dv">0</span>]</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Sentence:"</span>, <span class="st">' '</span>.join(sent2tokens(example_sent)))</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Predicted:"</span>, <span class="st">' '</span>.join(crf.predict([sent2features(example_sent, word2cluster)])[<span class="dv">0</span>]))</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Correct:"</span>, <span class="st">' '</span>.join(sent2labels(example_sent)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Sentence: Dat is in Italië , Spanje of Engeland misschien geen probleem , maar volgens ' Der Kaiser ' in Duitsland wel .
Predicted: O O O B-LOC O B-LOC O B-LOC O O O O O O O B-MISC I-MISC O O B-LOC O O
Correct: O O O B-LOC O B-LOC O B-LOC O O O O O O O B-PER I-PER O O B-LOC O O</code></pre>
</div>
</div>
<p>We are now ready to evalaute the whole test set. We print out a classification report for all labels except ‘O’. They are the majority of labels anyway, so they will skew the results (they are most probably assigned correctly).</p>
<div class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>labels <span class="op">=</span> <span class="bu">list</span>(crf.classes_)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>labels.remove(<span class="st">'O'</span>)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>y_pred <span class="op">=</span> crf.predict(X_test)</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>sorted_labels <span class="op">=</span> <span class="bu">sorted</span>(</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  labels,</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>  key<span class="op">=</span><span class="kw">lambda</span> name: (name[<span class="dv">1</span>:], name[<span class="dv">0</span>])</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="co"># The following code only runs with the updated metrics.py module in `sklearn_crfsuite` library.</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Here: pip install git+https://github.com/MeMartijn/updated-sklearn-crfsuite.git\#egg=sklearn_crfsuite</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(metrics.flat_classification_report(y_test, y_pred, labels<span class="op">=</span>sorted_labels))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>              precision    recall  f1-score   support

       B-LOC       0.83      0.82      0.83       774
       I-LOC       0.35      0.45      0.40        49
      B-MISC       0.81      0.61      0.70      1187
      I-MISC       0.54      0.41      0.46       410
       B-ORG       0.79      0.70      0.74       882
       I-ORG       0.75      0.61      0.67       551
       B-PER       0.82      0.88      0.85      1098
       I-PER       0.90      0.95      0.93       807

   micro avg       0.80      0.74      0.77      5758
   macro avg       0.72      0.68      0.70      5758
weighted avg       0.80      0.74      0.76      5758
</code></pre>
</div>
</div>
<p>We have good scores, especially <code>B-LOC</code> and <code>B-PER</code> score very good.</p>
<p>Next we will use the <code>eli5</code> library to have a look at the most likely transitions the CRF model has identified. <code>Eli5</code> helps us to explain the predictions of our CRF model</p>
<div class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="co">The code below does not work anymore with sklearn &gt; 23. Which is a pity, because it would give us good insights</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="co">into the transitions and decisions the CRF model makes. TRy it with py38 environment.</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="co">import eli5</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a><span class="co">eli5.show_weights(crf, top=20)</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="14">
<pre><code>'\nThe code below does not work anymore with sklearn &gt; 23. Which is a pity, because it would give us good insights\ninto the transitions and decisions the CRF model makes. TRy it with py38 environment.\n\n\nimport eli5\n\neli5.show_weights(crf, top=20)\n'</code></pre>
</div>
</div>
<section id="finding-the-optimal-hyperparameters" class="level2">
<h2 class="anchored" data-anchor-id="finding-the-optimal-hyperparameters">Finding the optimal hyperparameters</h2>
<p>So far we’ve trained a model with the default parameters. It’s unlikely that these will give us the best performance possible. Therefore we’re going to search automatically for the best hyperparameter settings by iteratively training different models and evaluating them. Eventually we’ll pick the best one.</p>
<p>Here we’ll focus on two parameters: c1 and c2. These are the parameters for L1 and L2 regularization, respectively. Regularization prevents overfitting on the training data by adding a penalty to the loss function. In L1 regularization, this penalty is the sum of the absolute values of the weights; in L2 regularization, it is the sum of the squared weights. L1 regularization performs a type of feature selection, as it assigns 0 weight to irrelevant features. L2 regularization, by contrast, makes the weight of irrelevant features small, but not necessarily zero. L1 regularization is often called the Lasso method, L2 is called the Ridge method, and the linear combination of both is called Elastic Net regularization.</p>
<p>We define the parameter space for c1 and c2 and use the flat F1-score to compare the individual models. We’ll rely on three-fold cross validation to score each of the 50 candidates. We use a randomized search, which means we’re not going to try out all specified parameter settings, but instead, we’ll let the process sample randomly from the distributions we’ve specified in the parameter space. It will do this 50 (n_iter) times. This process takes a while, but it’s worth the wait.</p>
<div class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> scipy</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> make_scorer</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> RandomizedSearchCV</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>crf <span class="op">=</span> crfsuite.CRF(</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>  algorithm<span class="op">=</span><span class="st">'lbfgs'</span>,</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>  max_iterations<span class="op">=</span><span class="dv">100</span>,</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>  all_possible_transitions<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>  keep_tempfiles<span class="op">=</span><span class="va">True</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>params_space <span class="op">=</span> {</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">'c1'</span>: scipy.stats.expon(scale<span class="op">=</span><span class="fl">0.5</span>),</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">'c2'</span>: scipy.stats.expon(scale<span class="op">=</span><span class="fl">0.05</span>),</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>f1_scorer <span class="op">=</span> make_scorer(metrics.flat_f1_score,</span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>                        average<span class="op">=</span><span class="st">'weighted'</span>, labels<span class="op">=</span>labels)</span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>rs <span class="op">=</span> RandomizedSearchCV(crf, params_space,</span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>                        cv<span class="op">=</span><span class="dv">3</span>,</span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>                        verbose<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a>                        n_jobs<span class="op">=-</span><span class="dv">1</span>,</span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a>                        n_iter<span class="op">=</span><span class="dv">50</span>,</span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a>                        scoring<span class="op">=</span>f1_scorer)</span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a>rs.fit(X_train, y_train)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Fitting 3 folds for each of 50 candidates, totalling 150 fits</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="15">
<style>#sk-container-id-2 {color: black;background-color: white;}#sk-container-id-2 pre{padding: 0;}#sk-container-id-2 div.sk-toggleable {background-color: white;}#sk-container-id-2 label.sk-toggleable__label {cursor: pointer;display: block;width: 100%;margin-bottom: 0;padding: 0.3em;box-sizing: border-box;text-align: center;}#sk-container-id-2 label.sk-toggleable__label-arrow:before {content: "▸";float: left;margin-right: 0.25em;color: #696969;}#sk-container-id-2 label.sk-toggleable__label-arrow:hover:before {color: black;}#sk-container-id-2 div.sk-estimator:hover label.sk-toggleable__label-arrow:before {color: black;}#sk-container-id-2 div.sk-toggleable__content {max-height: 0;max-width: 0;overflow: hidden;text-align: left;background-color: #f0f8ff;}#sk-container-id-2 div.sk-toggleable__content pre {margin: 0.2em;color: black;border-radius: 0.25em;background-color: #f0f8ff;}#sk-container-id-2 input.sk-toggleable__control:checked~div.sk-toggleable__content {max-height: 200px;max-width: 100%;overflow: auto;}#sk-container-id-2 input.sk-toggleable__control:checked~label.sk-toggleable__label-arrow:before {content: "▾";}#sk-container-id-2 div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-2 div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-2 input.sk-hidden--visually {border: 0;clip: rect(1px 1px 1px 1px);clip: rect(1px, 1px, 1px, 1px);height: 1px;margin: -1px;overflow: hidden;padding: 0;position: absolute;width: 1px;}#sk-container-id-2 div.sk-estimator {font-family: monospace;background-color: #f0f8ff;border: 1px dotted black;border-radius: 0.25em;box-sizing: border-box;margin-bottom: 0.5em;}#sk-container-id-2 div.sk-estimator:hover {background-color: #d4ebff;}#sk-container-id-2 div.sk-parallel-item::after {content: "";width: 100%;border-bottom: 1px solid gray;flex-grow: 1;}#sk-container-id-2 div.sk-label:hover label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-2 div.sk-serial::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 0;bottom: 0;left: 50%;z-index: 0;}#sk-container-id-2 div.sk-serial {display: flex;flex-direction: column;align-items: center;background-color: white;padding-right: 0.2em;padding-left: 0.2em;position: relative;}#sk-container-id-2 div.sk-item {position: relative;z-index: 1;}#sk-container-id-2 div.sk-parallel {display: flex;align-items: stretch;justify-content: center;background-color: white;position: relative;}#sk-container-id-2 div.sk-item::before, #sk-container-id-2 div.sk-parallel-item::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 0;bottom: 0;left: 50%;z-index: -1;}#sk-container-id-2 div.sk-parallel-item {display: flex;flex-direction: column;z-index: 1;position: relative;background-color: white;}#sk-container-id-2 div.sk-parallel-item:first-child::after {align-self: flex-end;width: 50%;}#sk-container-id-2 div.sk-parallel-item:last-child::after {align-self: flex-start;width: 50%;}#sk-container-id-2 div.sk-parallel-item:only-child::after {width: 0;}#sk-container-id-2 div.sk-dashed-wrapped {border: 1px dashed gray;margin: 0 0.4em 0.5em 0.4em;box-sizing: border-box;padding-bottom: 0.4em;background-color: white;}#sk-container-id-2 div.sk-label label {font-family: monospace;font-weight: bold;display: inline-block;line-height: 1.2em;}#sk-container-id-2 div.sk-label-container {text-align: center;}#sk-container-id-2 div.sk-container {/* jupyter's `normalize.less` sets `[hidden] { display: none; }` but bootstrap.min.css set `[hidden] { display: none !important; }` so we also need the `!important` here to be able to override the default hidden behavior on the sphinx rendered scikit-learn.org. See: https://github.com/scikit-learn/scikit-learn/issues/21755 */display: inline-block !important;position: relative;}#sk-container-id-2 div.sk-text-repr-fallback {display: none;}</style><div id="sk-container-id-2" class="sk-top-container"><div class="sk-text-repr-fallback"><pre>RandomizedSearchCV(cv=3,
                   estimator=CRF(algorithm='lbfgs',
                                 all_possible_transitions=True,
                                 keep_tempfiles=True, max_iterations=100),
                   n_iter=50, n_jobs=-1,
                   param_distributions={'c1': &lt;scipy.stats._distn_infrastructure.rv_frozen object at 0x7fe8e46521c0&gt;,
                                        'c2': &lt;scipy.stats._distn_infrastructure.rv_frozen object at 0x7fe8e4652700&gt;},
                   scoring=make_scorer(flat_f1_score, average=weighted, labels=['B-ORG', 'B-MISC', 'B-PER', 'I-PER', 'B-LOC', 'I-MISC', 'I-ORG', 'I-LOC']),
                   verbose=1)</pre><b>In a Jupyter environment, please rerun this cell to show the HTML representation or trust the notebook. <br>On GitHub, the HTML representation is unable to render, please try loading this page with nbviewer.org.</b></div><div class="sk-container" hidden=""><div class="sk-item sk-dashed-wrapped"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-2" type="checkbox"><label for="sk-estimator-id-2" class="sk-toggleable__label sk-toggleable__label-arrow">RandomizedSearchCV</label><div class="sk-toggleable__content"><pre>RandomizedSearchCV(cv=3,
                   estimator=CRF(algorithm='lbfgs',
                                 all_possible_transitions=True,
                                 keep_tempfiles=True, max_iterations=100),
                   n_iter=50, n_jobs=-1,
                   param_distributions={'c1': &lt;scipy.stats._distn_infrastructure.rv_frozen object at 0x7fe8e46521c0&gt;,
                                        'c2': &lt;scipy.stats._distn_infrastructure.rv_frozen object at 0x7fe8e4652700&gt;},
                   scoring=make_scorer(flat_f1_score, average=weighted, labels=['B-ORG', 'B-MISC', 'B-PER', 'I-PER', 'B-LOC', 'I-MISC', 'I-ORG', 'I-LOC']),
                   verbose=1)</pre></div></div></div><div class="sk-parallel"><div class="sk-parallel-item"><div class="sk-item"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-3" type="checkbox"><label for="sk-estimator-id-3" class="sk-toggleable__label sk-toggleable__label-arrow">estimator: CRF</label><div class="sk-toggleable__content"><pre>CRF(algorithm='lbfgs', all_possible_transitions=True, keep_tempfiles=True,
    max_iterations=100)</pre></div></div></div><div class="sk-serial"><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-4" type="checkbox"><label for="sk-estimator-id-4" class="sk-toggleable__label sk-toggleable__label-arrow">CRF</label><div class="sk-toggleable__content"><pre>CRF(algorithm='lbfgs', all_possible_transitions=True, keep_tempfiles=True,
    max_iterations=100)</pre></div></div></div></div></div></div></div></div></div></div>
</div>
</div>
<p>Runs now, since we installed a venv conda py38! But it uses scikit-learn 1.1.1 Duh?</p>
<div class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'best params:'</span>, rs.best_params_)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'best CV score:'</span>, rs.best_score_)</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'model size: </span><span class="sc">{:0.2f}</span><span class="st">M'</span>.<span class="bu">format</span>(rs.best_estimator_.size_ <span class="op">/</span> <span class="dv">1000000</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>best params: {'c1': 0.011676207714138713, 'c2': 0.006516931147184303}
best CV score: 0.7541792978982037
model size: 1.93M</code></pre>
</div>
</div>
<div class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>best_crf <span class="op">=</span> rs.best_estimator_</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>y_pred <span class="op">=</span> best_crf.predict(X_test)</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(metrics.flat_classification_report(</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    y_test, y_pred, labels<span class="op">=</span>sorted_labels, digits<span class="op">=</span><span class="dv">3</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>              precision    recall  f1-score   support

       B-LOC      0.846     0.860     0.853       774
       I-LOC      0.403     0.592     0.479        49
      B-MISC      0.838     0.617     0.710      1187
      I-MISC      0.669     0.434     0.527       410
       B-ORG      0.812     0.719     0.762       882
       I-ORG      0.786     0.639     0.705       551
       B-PER      0.834     0.899     0.865      1098
       I-PER      0.890     0.970     0.928       807

   micro avg      0.824     0.757     0.789      5758
   macro avg      0.760     0.716     0.729      5758
weighted avg      0.821     0.757     0.782      5758
</code></pre>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>