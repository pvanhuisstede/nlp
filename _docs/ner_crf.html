<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.0.38">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>nlp - NER with Conditional Random Fields (CRF)</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="nlp - NER with Conditional Random Fields (CRF)">
<meta property="og:description" content="CRF is a powerful technique before Deep Learning became popular.">
<meta property="og:site-name" content="nlp">
<meta name="twitter:title" content="nlp - NER with Conditional Random Fields (CRF)">
<meta name="twitter:description" content="CRF is a powerful technique before Deep Learning became popular.">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">nlp</span>
  </a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/pvanhuisstede/nlp/"><i class="bi bi-github" role="img">
</i> 
 </a>
  </li>  
</ul>
              <div class="quarto-toggle-container">
                  <a href="" class="quarto-reader-toggle nav-link" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
              </div>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">NER with Conditional Random Fields (CRF)</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">NLP Telematika tutorials</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./word_embeddings.html" class="sidebar-item-text sidebar-link">An introduction to word embeddings</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./pretrained_models.html" class="sidebar-item-text sidebar-link">NLP with pre-trained models: spaCy and Stanford NLP</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./discovering_topics.html" class="sidebar-item-text sidebar-link">Discovering and Visualizing Topics in Texts</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./spacy_ner.html" class="sidebar-item-text sidebar-link">Updating spaCy’s NER system</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ner_crf.html" class="sidebar-item-text sidebar-link active">NER with Conditional Random Fields (CRF)</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ner_pytorch.html" class="sidebar-item-text sidebar-link">NER with PyTorch</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./text_classification_sklearn.html" class="sidebar-item-text sidebar-link">“Traditional” Text Classification with Scikit-learn</a>
  </div>
</li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#sent2tokens" id="toc-sent2tokens" class="nav-link active" data-scroll-target="#sent2tokens">sent2tokens</a></li>
  <li><a href="#sent2labels" id="toc-sent2labels" class="nav-link" data-scroll-target="#sent2labels">sent2labels</a></li>
  <li><a href="#sent2features" id="toc-sent2features" class="nav-link" data-scroll-target="#sent2features">sent2features</a></li>
  <li><a href="#word2features" id="toc-word2features" class="nav-link" data-scroll-target="#word2features">word2features</a></li>
  <li><a href="#read_clusters" id="toc-read_clusters" class="nav-link" data-scroll-target="#read_clusters">read_clusters</a></li>
  <li><a href="#finding-the-optimal-hyperparameters" id="toc-finding-the-optimal-hyperparameters" class="nav-link" data-scroll-target="#finding-the-optimal-hyperparameters">Finding the optimal hyperparameters</a></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/pvanhuisstede/nlp/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block">NER with Conditional Random Fields (CRF)</h1>
</div>



<div class="quarto-title-meta">

    
    
  </div>
  

</header>

<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<p>CRF is a powerful technique before Deep Learning became popular. POS tagging of sequences in order to label the most important information related to the problem at hand: generic named entities (locations, people, and organizations) or more specialized entities such as disease or symptomes.</p>
<p>For this we use <code>sklearn-crfsuite</code>.</p>
<p>I guess, due to the upsurge of Deep Learning the <code>sklearn-crfsuite</code> is not updated anymore. So instead of the snippet below, we have to install an updated version of the library to be able to produce reports:</p>
<p>Data comes from NLTK:</p>
<p>Let’s have a look at the data. They are a list of tokenized sentences: the string, POS tag and it’s entity tag. Nowadays the POS tag is not used in deep learning, but with CRF it provides useful information: Nouns are more common denoting entities than verbs, so the POS tags carry useful information.</p>
<p>How does CRF work? Deep learning neural nets just learn their relevant features from the input texts themselves. CRFs learn the realtionship between <strong>the features we give them</strong> and the <strong>label of a token in a given context</strong>. They <strong>do not</strong> learn these features themselves, the quality of the model highly depends on the features we present to them.</p>
<p>We therefore:</p>
<ul>
<li><p>use a method to collect the features for every token:</p>
<ul>
<li>the word itself + POS tag</li>
<li>completely uppercase? starts with digit? starts with capital?</li>
<li>character bigram or trigram the word ends with</li>
<li>use a <code>bias</code> feature that always has the same value (through it the CRF model can learn the relative freq. of each label type in the training data)</li>
</ul></li>
<li><p>we use the word embeddings to give the model more information about the meaning of a word (500 wikipedia clusters of word embeddings). We read those from file and map each word to the ID of the cluster it is in. Define <code>read_clusters</code>.</p></li>
<li><p>we want the CRF to look at the context of a token. We provide the CRF with the 2 words on either side of the token: their case, POS tags. If there is no left or right, we give it that information: BOS or EOS.</p></li>
</ul>
<hr>
<section id="sent2tokens" class="level3">
<h3 class="anchored" data-anchor-id="sent2tokens">sent2tokens</h3>
<blockquote class="blockquote">
<pre><code> sent2tokens (sent)</code></pre>
</blockquote>
<hr>
</section>
<section id="sent2labels" class="level3">
<h3 class="anchored" data-anchor-id="sent2labels">sent2labels</h3>
<blockquote class="blockquote">
<pre><code> sent2labels (sent)</code></pre>
</blockquote>
<hr>
</section>
<section id="sent2features" class="level3">
<h3 class="anchored" data-anchor-id="sent2features">sent2features</h3>
<blockquote class="blockquote">
<pre><code> sent2features (sent, word2cluster)</code></pre>
</blockquote>
<hr>
</section>
<section id="word2features" class="level3">
<h3 class="anchored" data-anchor-id="word2features">word2features</h3>
<blockquote class="blockquote">
<pre><code> word2features (sent, i, word2cluster)</code></pre>
</blockquote>
<hr>
</section>
<section id="read_clusters" class="level3">
<h3 class="anchored" data-anchor-id="read_clusters">read_clusters</h3>
<blockquote class="blockquote">
<pre><code> read_clusters (cluster_file)</code></pre>
</blockquote>
<p>Let’s try the <code>sent2features</code> function out using the first word from the first training_sent:</p>
<p>Now we assign our training and test sets the appropriate labels:</p>
<p>Next we create a CRF model and start the training using the standard <code>lbfgs</code> algorithm for parameter estimation and run it for 100 iterations.</p>
<p>When done, we save the model using <code>joblib</code>.</p>
<p>There is an error, but this has to do with the sklearn version we use; to let the error disappear we should use sklearn &lt; 24.0.</p>
<p>Let’s see whether we can write our model to file:</p>
<p>With our model saved, we now can evaluate the output of our CRF model. We will load our model from file and test it on the full test set.</p>
<p>We will have a look at the first sentence.</p>
<p>We are now ready to evalaute the whole test set. We print out a classification report for all labels except ‘O’. They are the majority of labels anyway, so they will skew the results (they are most probably assigned correctly).</p>
<p>We have good scores, especially <code>B-LOC</code> and <code>B-PER</code> score very good.</p>
<p>Next we will use the <code>eli5</code> library to have a look at the most likely transitions the CRF model has identified. <code>Eli5</code> helps us to explain the predictions of our CRF model</p>
</section>
<section id="finding-the-optimal-hyperparameters" class="level2">
<h2 class="anchored" data-anchor-id="finding-the-optimal-hyperparameters">Finding the optimal hyperparameters</h2>
<p>So far we’ve trained a model with the default parameters. It’s unlikely that these will give us the best performance possible. Therefore we’re going to search automatically for the best hyperparameter settings by iteratively training different models and evaluating them. Eventually we’ll pick the best one.</p>
<p>Here we’ll focus on two parameters: c1 and c2. These are the parameters for L1 and L2 regularization, respectively. Regularization prevents overfitting on the training data by adding a penalty to the loss function. In L1 regularization, this penalty is the sum of the absolute values of the weights; in L2 regularization, it is the sum of the squared weights. L1 regularization performs a type of feature selection, as it assigns 0 weight to irrelevant features. L2 regularization, by contrast, makes the weight of irrelevant features small, but not necessarily zero. L1 regularization is often called the Lasso method, L2 is called the Ridge method, and the linear combination of both is called Elastic Net regularization.</p>
<p>We define the parameter space for c1 and c2 and use the flat F1-score to compare the individual models. We’ll rely on three-fold cross validation to score each of the 50 candidates. We use a randomized search, which means we’re not going to try out all specified parameter settings, but instead, we’ll let the process sample randomly from the distributions we’ve specified in the parameter space. It will do this 50 (n_iter) times. This process takes a while, but it’s worth the wait.</p>
<p>Runs now, since we installed a venv conda py38! But it uses scikit-learn 1.1.1 Duh?</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>